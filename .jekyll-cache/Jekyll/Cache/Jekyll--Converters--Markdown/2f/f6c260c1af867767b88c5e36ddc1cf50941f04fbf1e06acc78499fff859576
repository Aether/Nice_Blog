I"í+<h2 id="concurrency">Concurrency</h2>
<h3 id="two-models-for-concurrent-programming">Two Models for Concurrent Programming</h3>
<ul>
  <li>Shared memory â€” å¹¶å‘æ¨¡å—é€šè¿‡åœ¨å†…å­˜ä¸­è¯»å†™å…±äº«å¯¹è±¡è¿›è¡Œäº¤äº’ã€‚</li>
  <li>Message passing â€” sending messages to each other through a communication channel. Modules send off messages, and incoming messages to each module are queued up for handling.</li>
</ul>

<h3 id="åº”ç”¨">åº”ç”¨</h3>
<ul>
  <li>ç½‘ç»œä¸Šçš„ä¸¤å°è®¡ç®—æœºé€šè¿‡ç½‘ç»œè¿æ¥é€šè®¯</li>
  <li>æµè§ˆå™¨å’ŒWebæœåŠ¡å™¨ï¼ŒAè¯·æ±‚é¡µé¢ï¼ŒBå‘é€é¡µé¢æ•°æ®ç»™A</li>
  <li>å³æ—¶é€šè®¯è½¯ä»¶çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨</li>
  <li>åŒä¸€å°è®¡ç®—æœºä¸Šçš„ä¸¤ä¸ªç¨‹åºé€šè¿‡ç®¡é“è¿æ¥è¿›è¡Œé€šè®¯</li>
</ul>

<h2 id="process--thread">Process &amp; Thread</h2>
<h3 id="process">Process</h3>
<ul>
  <li>åœ¨åŒä¸€æœºå™¨ä¸Šç‹¬ç«‹äºå…¶å®ƒè¿›ç¨‹çš„ä¸€ä¸ªè¿è¡Œä¸­ç¨‹åºçš„å®ä¾‹ã€‚å®ƒæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€‚å¯è§†ä¸ºä¸€å°è™šæ‹Ÿæœºã€‚</li>
  <li>æ‹¥æœ‰æ•´å°è®¡ç®—æœºçš„èµ„æº</li>
  <li>ç§æœ‰ç©ºé—´ å½¼æ­¤éš”ç¦» ä¸å…±äº«å†…å­˜</li>
  <li>é€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œåä½œ</li>
  <li>JVMé€šå¸¸è¿è¡Œå•ä¸€è¿›ç¨‹ï¼Œä½†ä¹Ÿå¯ä»¥åˆ›å»ºæ–°çš„è¿›ç¨‹</li>
  <li>å…±äº«å¯å˜å¯¹è±¡æ—¶éœ€è¦åŒæ­¥</li>
</ul>

<h3 id="thread">Thread</h3>
<ul>
  <li>ä¸€ä¸ªè¿è¡Œä¸­ç¨‹åºçš„æ§åˆ¶è½¨è¿¹ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨ç¨‹åºä¸­æŸä¸ªä½ç½®æ‰§è¡Œï¼Œæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ—¶æ ˆã€‚å¯è§†ä¸ºä¸€ä¸ªè™šæ‹Ÿå¤„ç†å™¨ã€‚</li>
  <li>å…±äº«å†…å­˜ æ¶ˆæ¯é˜Ÿåˆ—</li>
  <li>è½»é‡çº§</li>
  <li>å…±äº«å¯å˜å¯¹è±¡æ—¶éœ€è¦åŒæ­¥</li>
  <li>unsafe to kill</li>
</ul>

<h4 id="new-thread">new Thread</h4>

<ul>
  <li>(Seldom used) Subclassing Thread.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MyThread extends Thread {
@Override
public void run() {
  ...
}
}
(new MyThread()).start();
</code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(new MyThread()).run();å¯è¿è¡Œï¼Œæœªå¯åŠ¨çº¿ç¨‹
</code></pre></div>    </div>
  </li>
  <li>(More generally used) ä»Runnableæ¥å£æ„é€ Threadå¯¹è±¡
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new Thread(new Runnable() {
 public void run() {
     System.out.println("Hello");
 }
}).start();
</code></pre></div>    </div>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MyThread implements Runnable {
@Override
public void run() {
  ...
}
(new Thread(new MyThread())).start();
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="heisenbugs">Heisenbugs</h3>
<p>Nondeterministic and hard to reproduce <br />
A heisenbug may even disappear when you try to look at it with println or debugger</p>
<h3 id="bohrbugs">Bohrbugs</h3>
<p>Showing up repeatedly whenever you look at it.</p>
<h2 id="interleaving-and-race-condition">Interleaving and Race Condition</h2>
<h3 id="time-slicing">Time slicing</h3>
<ul>
  <li>åœ¨å•æ ¸è®¡ç®—æœºä¸­ï¼Œæ¯ä¸€æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å®é™…è¿è¡Œã€‚å•ä¸ªæ ¸å¿ƒçš„è¿è¡Œæ—¶é—´é€šè¿‡æ“ä½œç³»ç»Ÿçš„ç‰¹æ€§è¢«å„ä¸ªè¿›ç¨‹å’Œçº¿ç¨‹å…±äº«ï¼Œè¿™ç§è¡Œä¸ºç§°ä¸ºæ—¶é—´åˆ†ç‰‡ã€‚</li>
  <li>åœ¨å¤šæ ¸è®¡ç®—æœºä¸­ï¼Œå½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ•°æ—¶ï¼Œä¹Ÿé€šè¿‡æ—¶é—´åˆ†ç‰‡æ¥æ¨¡æ‹Ÿçº¿ç¨‹å¹¶è¡Œè¿è¡Œã€‚</li>
  <li>æ—¶é—´åˆ‡ç‰‡ä¸å¯é¢„æµ‹ã€ä¸ç¡®å®šï¼Œè¿™æ„å‘³ç€çº¿ç¨‹å¯ä»¥éšæ—¶æš‚åœæˆ–æ¢å¤</li>
</ul>

<h3 id="shared-memory-among-threads">Shared Memory among Threads</h3>
<ul>
  <li>Interleaving äº¤å‰å­˜å– â€” å½“ä¸¤çº¿ç¨‹å¹¶è¡Œè¿è¡Œæ—¶ï¼Œåº•å±‚æŒ‡ä»¤å¯èƒ½äº¤é”™è¿è¡Œ</li>
</ul>

<h3 id="race-condition">Race Condition</h3>
<ul>
  <li>The correctness of the program (the satisfaction of postconditions and invariants) depends on the relative timing of events in concurrent computations A and B. When this happens, we say â€œA is in a race with B.â€</li>
  <li>å•è¡Œã€å•æ¡è¯­å¥éƒ½æœªå¿…æ˜¯åŸå­çš„ã€‚æ˜¯å¦åŸå­ç”±JVMç¡®å®š</li>
  <li>also called â€œThread Interferenceâ€</li>
</ul>

<h2 id="some-operations-for-interfering-automatic-interleaving-of-threads">Some operations for interfering automatic interleaving of threads</h2>
<h3 id="threadsleep">Thread.sleep()</h3>
<ul>
  <li>ä¸ä¼šå¤±å»å¯¹ç°æœ‰monitoré”çš„æ‰€æœ‰æƒ</li>
  <li>åœ¨sleep()çš„æ—¶å€™æ£€æµ‹æ˜¯å¦æ”¶åˆ°åˆ«äººçš„ä¸­æ–­ä¿¡å·, catch(IntterruptedException e)</li>
</ul>

<h3 id="threadinterrupt">Thread.interrupt()</h3>
<ul>
  <li>t.interrupt()</li>
  <li>t.isInterrupted()
-æ­£å¸¸è¿è¡ŒæœŸé—´ï¼Œå³ä½¿å—åˆ°ä¸­æ–­ä¿¡å·ä¹Ÿä¸ç†ä¼š</li>
</ul>

<h3 id="threadyield-é¿å…ä½¿ç”¨">Thread.yield() (é¿å…ä½¿ç”¨)</h3>
<ul>
  <li>çº¿ç¨‹ä¼šå‘Šè¯‰è°ƒåº¦å™¨å¯ä»¥æ”¾å¼ƒCPUçš„å ç”¨æƒ, ä»è€Œå¯èƒ½å¼•èµ·è°ƒåº¦å™¨å”¤é†’å…¶ä»–çº¿ç¨‹</li>
</ul>

<h3 id="threadjoin">Thread.join()</h3>
<ul>
  <li>è®©å½“å‰çº¿ç¨‹ä¿æŒæ‰§è¡Œï¼Œç›´åˆ°å…¶æ‰§è¡Œç»“æŸ</li>
</ul>

<h3 id="objectwait">object.wait()</h3>
<ul>
  <li>ä½¿ç”¨å‰æä¸ºçº¿ç¨‹å·²è·å¾—è¢«è°ƒç”¨å¯¹è±¡çš„å¯¹è±¡é”ã€‚å½“å‰çº¿ç¨‹æ”¾å¼ƒå¯¹è±¡é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å…¶å®ƒè·å¾—è¯¥å¯¹è±¡é”çš„çº¿ç¨‹å¯¹è¯¥å¯¹è±¡è°ƒç”¨notify()æˆ–notifyAll()æ–¹æ³•ã€‚å½“å‰çº¿ç¨‹è¢«é€šçŸ¥æˆ–è¢«ä¸­æ–­æ—¶ï¼Œå°è¯•é‡æ–°è·å¾—é”å¹¶ç»§ç»­è¿è¡Œã€‚è‹¥è¢«ä¸­æ–­ï¼ŒInterruptedExceptionå°†åœ¨è·å¾—å¯¹è±¡é”ä¹‹åæŠ›å‡ºã€‚</li>
</ul>

<h2 id="thread-safety">Thread Safety</h2>
<h3 id="confinement">Confinement</h3>
<ul>
  <li>Donâ€™t share: isolate mutable state in individual threads</li>
  <li>å°†å¯å˜æ•°æ®é™åˆ¶åœ¨å•ä¸€çº¿ç¨‹å†…éƒ¨ï¼Œé¿å…ç«äº‰</li>
  <li>ä¸å…è®¸ä»»ä½•çº¿ç¨‹ç›´æ¥è¯»å†™è¯¥æ•°æ®</li>
  <li>é¿å…å…¨å±€å˜é‡ å¦‚Singletonè®¾è®¡æ¨¡å¼ ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨getInstance()è¿èƒŒè®¾è®¡</li>
</ul>

<h3 id="immutability">Immutability</h3>
<ul>
  <li>Donâ€™t mutate: share only immutable state</li>
  <li>å…±äº«ä¸å¯å˜çš„å¼•ç”¨å’Œæ•°æ®ç±»å‹</li>
  <li>å¦‚æœä½¿ç”¨äº†beneficent mutationè¿˜æ˜¯è¦åŠ é”</li>
  <li>ä¸å«mutatoræ–¹æ³•</li>
  <li>æ‰€æœ‰å­—æ®µå¿…é¡»è¢«private finalä¿®é¥°</li>
  <li>å­ç±»ä¸å¯é‡å†™æ–¹æ³•</li>
  <li>æ²¡æœ‰è¡¨ç¤ºæ³„éœ²</li>
  <li>è¡¨ç¤ºä¸­çš„å¯å˜å¯¹è±¡ä¸å¾—å˜åŒ–</li>
</ul>

<h3 id="using-threadsafe-data-types">Using Threadsafe Data Types</h3>
<ul>
  <li>Threadsafe Collections</li>
  <li>private static Map&lt;Integer,Boolean&gt; cache = Collections.synchronizedMap(new HashMap&lt;&gt;());</li>
  <li>å¤šä¸ªæ“ä½œé—´ä¸ä¿è¯å®‰å…¨ å¦‚(!list.isEmpty()) list.get(0)</li>
</ul>

<h3 id="locks-and-synchronization">Locks and Synchronization</h3>
<ul>
  <li>åœ¨ä½¿ç”¨synchronizedMap(hashMap)ä¹‹åï¼Œä¸è¦å†æŠŠå‚æ•°hashMapå…±äº«ç»™å…¶ä»–çº¿ç¨‹ï¼Œä¸è¦ä¿ç•™åˆ«åï¼Œä¸€å®šè¦å½»åº•é”€æ¯</li>
  <li>å³ä½¿åœ¨çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ä¸Šï¼Œä½¿ç”¨iteratorä¹Ÿæ˜¯ä¸å®‰å…¨çš„ï¼ˆé™¤éä½¿ç”¨lockæœºåˆ¶ï¼‰</li>
  <li>å³ä½¿æ˜¯çº¿ç¨‹å®‰å…¨çš„collectionç±»ï¼Œä»å¯èƒ½äº§ç”Ÿç«äº‰</li>
</ul>

<h3 id="volatile">Volatile</h3>
<ul>
  <li>volatileä¹Ÿå¯ä¿è¯åŸºæœ¬ç±»å‹å˜é‡å˜åŒ–å¯¹äºæ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§ï¼ˆåŒæ­¥ç¼“å­˜ï¼‰ï¼Œä½†ä¸ä¸€å®šä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚</li>
  <li>å½“ä¸”ä»…å½“å¯¹volatileä¿®é¥°çš„å˜é‡è¿›è¡Œçš„ä¿®æ”¹ä¸ä»»ä½•å˜é‡ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰çš„å€¼æ— å…³æ—¶ï¼Œå…¶æ‰æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>

<h3 id="çº¿ç¨‹å®‰å…¨ç­–ç•¥æ’°å†™">çº¿ç¨‹å®‰å…¨ç­–ç•¥æ’°å†™</h3>
<ul>
  <li>é‡‡å–äº†å››ç§æ–¹æ³•ä¸­çš„å“ªä¸€ç§</li>
  <li>å¦‚æœæ˜¯åä¸¤ç§ï¼Œè¿˜éœ€è€ƒè™‘å¯¹æ•°æ®çš„è®¿é—® éƒ½æ˜¯åŸå­çš„ï¼Œä¸å­˜åœ¨interleaving</li>
</ul>

<h4 id="confinement-1">Confinement</h4>
<ul>
  <li>å±€é™è®¿é—®ç­–ç•¥é€šå¸¸ä¸é€‚ç”¨äºä»…ä»…è®¨è®ºä¸€ä¸ªæ•°æ®ç±»å‹çš„æƒ…å†µï¼Œå› ä¸ºä½ éœ€è¦çŸ¥é“ç³»ç»Ÿä¸­å­˜åœ¨å“ªäº›çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯è®¿é—®å“ªäº›å¯¹è±¡ã€‚</li>
  <li>è‹¥è®¿é—®è¯¥æ•°æ®ç±»å‹çš„çº¿ç¨‹å‡ç”±è‡ªèº«åˆ›å»ºï¼Œåˆ™å¯è®¨è®ºè¿™äº›çº¿ç¨‹é—´å¦‚ä½•ä¿æŒè®¿é—®çš„å±€é™æ€§</li>
  <li>è‹¥çº¿ç¨‹æ¥è‡ªäºå¤–éƒ¨ï¼Œåˆ™æ— æ³•è®¨è®º</li>
  <li>é€šå¸¸åœ¨å°†ç³»ç»Ÿä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè®¨è®ºä¸€äº›æ¨¡å—æˆ–æ•°æ®ç±»å‹ä¸éœ€è¦çº¿ç¨‹å®‰å…¨çš„åŸå› æ—¶ï¼Œä¼šä»è®¾è®¡çš„è§’åº¦è®ºè¯çº¿ç¨‹é—´ä¸ä¼šå…±äº«æ•°æ®ã€‚</li>
</ul>

<h4 id="immutability-1">Immutability</h4>
<ul>
  <li>è¯´æ˜å¯¹è±¡ä¸­æ•°æ®ä¸ºä½•èƒ½å¤Ÿä¿æŒä¸å¯å˜æ€§å³å¯</li>
</ul>

<h4 id="using-threadsafe-data-types-1">Using Threadsafe Data Types</h4>
<ul>
  <li>è¡¨æ˜è¯¥æ•°æ®ç±»å‹çš„æ‰€æœ‰åŸå­æ“ä½œéƒ½è¢«æ°å½“åœ°è®¾è®¡ï¼Œä½¿å¾—è¯¥æ•°æ®ç±»å‹ä¾èµ–çš„ä¸å˜å¼ä¸å—åŸå­æ“ä½œçš„äº¤é”™æ‰§è¡Œå½±å“ã€‚</li>
  <li>nodeså’Œedgesä¸¾ä¾‹</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private final Set&lt;Node&gt; nodes = Collections.synchronizedSet(new HashSet&lt;&gt;());
private final Map&lt;Node,Set&lt;Node&gt;&gt; edges = Collections.synchronizedMap(new HashMap&lt;&gt;());
// è¡¨ç¤ºä¸å˜å¼ï¼š
// å¯¹äºæ‰€æœ‰æ»¡è¶³yæ˜¯edges.get(x)çš„æˆå‘˜çš„äºŒå…ƒç»„xå’Œyï¼Œx,yéƒ½æ˜¯nodesçš„æˆå‘˜ã€‚
è¯¥ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºï¼šnodeså’Œedgeséƒ½å£°æ˜ä¸ºfinalï¼Œå› æ­¤å®ƒä»¬éƒ½æ˜¯ä¸å¯å˜çš„ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
</code></pre></div></div>

<blockquote>
  <p>nodeså’Œedgeséƒ½æŒ‡å‘çº¿ç¨‹å®‰å…¨çš„Setå’ŒMapæ•°æ®ç±»å‹ã€‚
è¯¥è®ºè¯ä»…é˜²æ­¢äº†æŸäº›ç«äº‰æ¡ä»¶ï¼Œä½†ä¸æ˜¯å…¨éƒ¨ã€‚ç”±äºè¯¥ç±»çš„è¡¨ç¤ºä¸å˜å¼ä¸­è¦æ±‚äº†nodesä¸edgesæˆå‘˜é—´çš„å…³ç³»ï¼Œå› æ­¤è¿˜åº”è®ºè¯ä¸¤è€…æˆå‘˜çš„æ”¹å˜åº”å½“æ˜¯åŒæ—¶çš„ã€åŸå­çš„ã€‚è‹¥è¯¥ç‚¹æ— æ³•è¯æ˜ï¼Œåˆ™å¯ä»¥æ„é€ ç«äº‰æ¡ä»¶ã€‚</p>
</blockquote>

<h4 id="locks-and-synchronization-1">Locks and Synchronization</h4>
<ul>
  <li>è¡¨æ˜è¯¥æ•°æ®ç±»å‹çš„æ‰€æœ‰åŸå­æ“ä½œéƒ½è¢«æ°å½“åœ°è®¾è®¡ï¼Œä½¿å¾—è¯¥æ•°æ®ç±»å‹ä¾èµ–çš„ä¸å˜å¼ä¸å—åŸå­æ“ä½œçš„äº¤é”™æ‰§è¡Œå½±å“ã€‚</li>
</ul>

<h2 id="locks-and-synchronization-2">Locks and Synchronization</h2>
<h3 id="monitoræ¨¡å¼adtæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯äº’æ–¥è®¿é—®">Monitoræ¨¡å¼:ADTæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯äº’æ–¥è®¿é—®</h3>
<ul>
  <li>reads must be guarded as well as writes</li>
  <li>public synchronized void fun(){â€¦} == synchronized(this)</li>
</ul>

<h3 id="fine-grained-synchronization">fine-grained synchronization.</h3>
<p>synchronized(object)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public synchronized Constructor(){
  ...
} // wrong
</code></pre></div></div>
<ul>
  <li>ç”¨ADTè‡ªå·±åšlock</li>
</ul>

<h3 id="lock">Lock</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Object lock = new Object();
synchronized (lock) {
  ...
}
</code></pre></div></div>

<h2 id="liveness">Liveness</h2>
<h3 id="deadlock">Deadlock</h3>
<p>å¤šä¸ªçº¿ç¨‹ç«äº‰lockï¼Œç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾lock</p>

<h4 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆï¼š</h4>

<ol>
  <li>ä¸¤çº¿ç¨‹å‡æŒ‰é¡ºåºå¾ç”¨é”-ä¸¤ä¸ªçº¿ç¨‹å‡å…ˆè·å¾—Aé”å†è·å¾—Bé”
    <ul>
      <li>ç¼ºç‚¹1:ä¸æ˜¯æ¨¡å—åŒ–çš„â€”â€”ä»£ç å¿…é¡»çŸ¥é“ç³»ç»Ÿä¸­çš„æ‰€æœ‰é”ï¼Œæˆ–è€…è‡³å°‘çŸ¥é“å­ç³»ç»Ÿä¸­çš„æ‰€æœ‰é”</li>
      <li>ç¼ºç‚¹2:ä»£ç å¯èƒ½å¾ˆéš¾æˆ–ä¸å¯èƒ½åœ¨è·å–ç¬¬ä¸€ä¸ªé”ä¹‹å‰å‡†ç¡®åœ°çŸ¥é“å®ƒéœ€è¦å“ªäº›é” <br /></li>
    </ul>
  </li>
  <li>ç²—ç²’åº¦çš„lock
    <ul>
      <li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸‹é™</li>
    </ul>
  </li>
</ol>

<h3 id="starvation">Starvation</h3>
<ul>
  <li>å› ä¸ºå…¶ä»–çº¿ç¨‹lockæ—¶é—´å¤ªé•¿ï¼Œä¸€ä¸ªçº¿ç¨‹é•¿æ—¶é—´æ— æ³•è·å–å…¶æ‰€éœ€çš„èµ„æºè®¿é—®æƒ(lock)ï¼Œå¯¼è‡´æ— æ³•å¾€ä¸‹è¿›è¡Œ</li>
</ul>

<h3 id="livelock">Livelock</h3>
<ul>
  <li>ä¸¤çº¿ç¨‹çš„è¡Œä¸ºäº’ç›¸ç”±å¯¹æ–¹çš„è¡Œä¸ºå†³å®šï¼ˆé€šå¸¸æ˜¯ä¸ºäº†é¿å…æ­»é”ï¼‰ï¼Œçº¿ç¨‹æ²¡æœ‰é”æ­»ï¼Œä»åœ¨æ­£å¸¸è¿è¡Œï¼Œä½†æ— æ³•æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
:ET